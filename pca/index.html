<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCA Visualization - Persona 2</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        #container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #viz {
            margin: 20px auto;
        }
        .point {
            cursor: pointer;
            transition: all 0.2s;
        }
        .point:hover {
            stroke: #000;
            stroke-width: 2px;
        }
        #tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            font-size: 12px;
        }
        #legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .legend-marker {
            width: 20px;
            height: 20px;
            border: 1px solid black;
        }
        #controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1 id="title">PCA Visualization of Text Embeddings (Persona 2)</h1>
        
        <div id="controls">
            <div class="checkbox-group">
                <label><input type="checkbox" id="show-kept" checked> ○ Kept data</label>
                <label><input type="checkbox" id="show-question" checked> ▲ Questions</label>
                <label><input type="checkbox" id="show-qpref" checked> ★ Q+Pref</label>
                <label><input type="checkbox" id="show-pref" checked> ■ Preferences</label>
            </div>
        </div>
        
        <div id="viz"></div>
        <div id="legend"></div>
    </div>
    <div id="tooltip"></div>

    <script>
        const width = 1200;
        const height = 800;
        const margin = {top: 20, right: 20, bottom: 40, left: 60};

        const svg = d3.select("#viz")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("#tooltip");

        const markerSymbols = {
            'kept': d3.symbolCircle,
            'question': d3.symbolTriangle,
            'question+pref': d3.symbolStar,
            'preference': d3.symbolSquare
        };

        const markerLabels = {
            'kept': '○ Kept data',
            'question': '▲ Questions',
            'question+pref': '★ Question+Preference',
            'preference': '■ Preferences'
        };

        d3.json('pca_persona2_data.json').then(data => {
            // Update title with explained variance
            d3.select("#title").text(
                `PCA Visualization of Text Embeddings (Persona 2) - Explained Variance: ${(data.explained_variance * 100).toFixed(2)}%`
            );

            const xExtent = d3.extent(data.points, d => d.x);
            const yExtent = d3.extent(data.points, d => d.y);

            const xScale = d3.scaleLinear()
                .domain(xExtent)
                .range([0, width - margin.left - margin.right])
                .nice();

            const yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([height - margin.top - margin.bottom, 0])
                .nice();

            // Add axes
            g.append("g")
                .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .append("text")
                .attr("x", (width - margin.left - margin.right) / 2)
                .attr("y", 35)
                .attr("fill", "black")
                .style("font-size", "14px")
                .text("PC1");

            g.append("g")
                .call(d3.axisLeft(yScale))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -(height - margin.top - margin.bottom) / 2)
                .attr("fill", "black")
                .style("font-size", "14px")
                .text("PC2");

            // Add grid
            g.append("g")
                .attr("class", "grid")
                .attr("opacity", 0.1)
                .call(d3.axisLeft(yScale).tickSize(-(width - margin.left - margin.right)).tickFormat(""));

            // Draw points
            const points = g.selectAll(".point")
                .data(data.points)
                .enter()
                .append("path")
                .attr("class", d => `point point-${d.type}`)
                .attr("d", d3.symbol().type(d => markerSymbols[d.type]).size(150))
                .attr("transform", d => `translate(${xScale(d.x)},${yScale(d.y)})`)
                .attr("fill", d => d.color)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("opacity", 0.7)
                .on("mouseover", function(event, d) {
                    // Highlight all points with the same preference
                    g.selectAll(".point")
                        .attr("opacity", p => p.preference === d.preference ? 1 : 0.2)
                        .attr("stroke-width", p => p.preference === d.preference ? 2 : 1);
                    
                    tooltip
                        .style("opacity", 1)
                        .html(`
                            <strong>Type:</strong> ${markerLabels[d.type]}<br>
                            <strong>Preference:</strong> ${d.preference}<br>
                            <strong>Text:</strong> ${d.text}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    // Reset all points to default style
                    g.selectAll(".point")
                        .attr("stroke-width", 1)
                        .attr("opacity", 0.7);
                    
                    tooltip.style("opacity", 0);
                });

            // Create legend
            const legend = d3.select("#legend");
            
            // Group preferences by type
            const prefByType = {};
            data.points.forEach(p => {
                if (!prefByType[p.preference]) {
                    prefByType[p.preference] = {
                        color: p.color,
                        kept: 0,
                        question: 0
                    };
                }
            });

            // Count
            Object.keys(data.counts.kept).forEach(pref => {
                if (prefByType[pref]) prefByType[pref].kept = data.counts.kept[pref];
            });
            Object.keys(data.counts.questions).forEach(pref => {
                if (prefByType[pref]) prefByType[pref].question = data.counts.questions[pref];
            });

            Object.entries(prefByType).forEach(([pref, info]) => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div")
                    .attr("class", "legend-marker")
                    .style("background-color", info.color);
                
                const label = pref === "No preference" 
                    ? `[${info.kept}] ${pref}`
                    : `[Kept:${info.kept} | Q:${info.question}] ${pref.substring(0, 50)}${pref.length > 50 ? '...' : ''}`;
                item.append("span").text(label);
            });

            // Add marker type legend
            legend.append("div").style("width", "100%").style("margin-top", "10px");
            Object.entries(markerLabels).forEach(([type, label]) => {
                const item = legend.append("div").attr("class", "legend-item");
                const svg = item.append("svg").attr("width", 20).attr("height", 20);
                svg.append("path")
                    .attr("d", d3.symbol().type(markerSymbols[type]).size(100))
                    .attr("transform", "translate(10,10)")
                    .attr("fill", "gray")
                    .attr("stroke", "black")
                    .attr("stroke-width", 1);
                item.append("span").text(label);
            });

            // Filter controls
            d3.select("#show-kept").on("change", function() {
                g.selectAll(".point-kept").style("display", this.checked ? null : "none");
            });
            d3.select("#show-question").on("change", function() {
                g.selectAll(".point-question").style("display", this.checked ? null : "none");
            });
            d3.select("#show-qpref").on("change", function() {
                g.selectAll(".point-question\\+pref").style("display", this.checked ? null : "none");
            });
            d3.select("#show-pref").on("change", function() {
                g.selectAll(".point-preference").style("display", this.checked ? null : "none");
            });
        });
    </script>
</body>
</html>
